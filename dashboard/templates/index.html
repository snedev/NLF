{% extends "base.html" %}

{% block content %}

{% load static %}
<!-- JQuery -->
        <script type="text/javascript" src="{% static 'js/jquery-3.4.1.min.js' %}"></script>
        <!-- Bootstrap tooltips -->
        <script type="text/javascript" src="{% static 'js/popper.min.js' %}"></script>
        <!-- Bootstrap core JavaScript -->
        <script type="text/javascript" src="{% static 'js/bootstrap.min.js' %}"></script>
        <!-- MDB core JavaScript -->
         <script type="text/javascript" src="{% static 'js/mdb.min.js' %}"></script>
        <!-- Plotly.js -->
        <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
var jsdata = [];
$(function () {
    var frm = $('#data_selector');
    frm.submit(function (ev) {
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
                jsdata.push(data);
            var graphDiv = document.getElementById('graphDiv');
            var traces = [];
            for (var key in data) {
                if (key !== 'time') {
                var trace = {
                    x: Object.values(data['time']),
                    y: Object.values(data[key]),
                    name: key
                };
                traces.push(trace);
            }}
            var layout = {
                    overlaying: 'y'
                };
            for (var i = 0; i < traces.length; i++) {
                traces[i].yaxis = 'y' + (i + 1);
                if (i > 0) {
                   layout['yaxis' + (i + 1)] =  {
                       overlaying: 'y',
                       side: 'right'
                   }}
            }
	        Plotly.newPlot( graphDiv, traces, layout);
            }
        });
        ev.preventDefault();
    });
});
</script>
<script>
$(function () {
    var frm = $('#nlu_selector');
    frm.submit(function (ev) {
        $.ajax({
            type: frm.attr('method'),
            url: frm.attr('action'),
            data: frm.serialize(),
            success: function (data) {
                jsdata.push(data);
            var graphDiv = document.getElementById('graphDiv');
            var traces = [];
            for (var key in data) {
                if (key !== 'time') {
                var trace = {
                x: Object.values(data['time']),
                y: Object.values(data[key]),
                name: key
                };
                traces.push(trace);
            }}
            var input = $("<input>", { type: "hidden", name: "plot_data", value: JSON.stringify(jsdata) });
            $('#nlu_selector').append($(input));
	        Plotly.newPlot( graphDiv, traces);
            }
        });
        ev.preventDefault();
    });
});
</script>

<div class="container">

    <h1>Select a Currency Pair and a Date Range</h1>

    <form id="data_selector" action="/data" method="post">
    {% csrf_token %}
        <div id="currencies">
            <input type="checkbox" name="currency_pairs" id="{{ cpairs.Bitcoin }}" value="{{ cpairs.Bitcoin }}">
                <label for="{{ cpairs.Bitcoin }}">{{ cpairs.Bitcoin }}</label>
            <input type="checkbox" name="currency_pairs" id="{{ cpairs.Ethereum }}" value="{{ cpairs.Ethereum }}">
                <label for="{{ cpairs.Ethereum }}">{{ cpairs.Ethereum }}</label>
            <input type="checkbox" name="currency_pairs" id="{{ cpairs.Litecoin }}" value="{{ cpairs.Litecoin }}">
                <label for="{{ cpairs.Litecoin }}">{{ cpairs.Litecoin }}</label>
            <input type="checkbox" name="currency_pairs" id="{{ cpairs.Ripple }}" value="{{ cpairs.Ripple }}">
                <label for="{{ cpairs.Ripple }}">{{ cpairs.Ripple }}</label>
            <input type="checkbox" name="currency_pairs" id="{{ cpairs.EURUSD }}" value="{{ cpairs.EURUSD }}">
                <label for="{{ cpairs.EURUSD }}">{{ cpairs.EURUSD }}</label>
        </div>

        <div id="date">
            <p> From: <input type="datetime-local" name="date_from" form="data_selector">
                To: <input type="datetime-local" name="date_to" form="data_selector">
            </p>
        </div>

        <div id="data_analysis">
            <h2>Instruments</h2>
            <input type="checkbox" name="data_analysis" id="MA21" form="data_selector" value="ma21">
                <label for="ma21">MA21</label>
            <input type="checkbox" name="data_analysis" id="MA100" form="data_selector" value="ma100">
                <label for="ma100">MA100</label>
            <input type="checkbox" name="data_analysis" id="MACD" form="data_selector" value="macd">
                <label for="macd">MACD</label>
        </div>

        <input type="submit" id="submit" value="Submit">
    </form>
    <div id="nlu_container">
        <form id="nlu_selector" action="/nlu" method="post">
        {% csrf_token %}
        <div id="nlu_form">
            <h1>Type in a query..</h1>
            <input type="text" name="nlu_text" id="nlu_text" form="nlu_selector" size="80" placeholder="Ex. Plot me the Bitcoin price from 25th December 2017 to 20th January 2018">
            <input type="submit" id="submit_nlu" value="Submit">
        </div>
        </form>
    </div>
  <!-- Plotly.js -->

    <div id="graphDiv"><!-- The Plotly chart goes here --></div>

</div>

{% endblock %}